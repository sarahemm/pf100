#!/usr/bin/env ruby

require 'optparse'
require './pf100-record.rb'
require './pf100-packet.rb'
require './pf100-meter.rb'
require 'date'

options = {}
options[:outfile] = nil
options[:setup] = false
options[:delete] = false
OptionParser.new do |opts|
  opts.banner = "Usage: #{$0} [options]"

  opts.on("-o", "--outfile [OUTFILE]", "File to write records to", "(defaults to stdout)") do |outfile|
    options[:outfile] = outfile
  end
  
  opts.on("-s", "--setup", "Perform USB device setup", "(required before first run on some platforms)") do |setup|
    options[:setup] = true
  end

  opts.on("-d", "--delete", "Delete records from meter after download") do |delete|
    options[:delete] = true
  end

  opts.on_tail("-h", "--help", "Show this message") do
    puts opts
    exit
  end
end.parse!

if(options[:setup]) then
  if(PF100Meter::setup) then
    puts "Driver setup complete.\nYou must now disconnect and reconnect the meter or, on some platforms, reboot before the meter will work."
  else
    puts "Driver setup failed."
  end
  Kernel.exit 1
end

meter = PF100Meter.new
while(!meter.connected?)
  STDERR.puts "Waiting for PF100 meter to be connected..."
  sleep 2
  meter.connect
end
puts "Found PF100."

while(!meter.ping)
  STDERR.puts "Please turn PF100 on now."
  sleep 2
end
STDERR.puts "PF100 meter initialized."

STDERR.puts "Reading memory records..."
records = meter.get_records
outfile = STDOUT
outfile = open(options[:outfile], "a") if options[:outfile]
if (File.zero?(outfile))
  outfile.puts "Date,Time,PEF,FEV1"
  last_datetime = DateTime.new(1970)
elsif options[:outfile]
  outfile_examine = open(options[:outfile],"r+")
  last_reading = outfile_examine.to_a.last
  last_date = last_reading[0,last_reading.index(',')]
  rest_of_record = last_reading[last_reading.index(',')+1...-1]
  last_time = rest_of_record[0,rest_of_record.index(',')]
  last_datetime = DateTime.strptime(last_date+last_time,'%Y-%m-%d%H:%M')
  outfile_examine.close
end
records.each do |record|
  if (record.time > last_datetime)
    date = record.time.strftime("%F")
    time = record.time.strftime("%R")
    outfile.printf "%s,%s,%d,%f\n", date, time, record.pef, record.fev  
  end    
end
outfile.close if options[:outfile]

if(options[:delete]) then
  if(meter.clear_all_data) then
    puts "Deleted records from meter."
  else
    puts "Failed to delete records from meter."
  end
end
